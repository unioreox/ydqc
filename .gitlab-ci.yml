image: node:20

cache:
  paths:
    - node_modules/

stages:
  - install
  - build
  - release

# 第一阶段：安装依赖
install:
  stage: install
  script:
    - echo "第一阶段：安装依赖"
    - npm config set registry https://registry.npmmirror.com
    - npm install

# 第二阶段：构建
build:
  stage: build
  script:
    - echo "第二阶段：开始构建产物"
    - npm run build-only
    - tar -czvf dist.tar.gz -C dist . # 打包 dist 文件夹内容
  artifacts:
    paths:
      - dist.tar.gz # 保存压缩包为 GitLab 产物供后续步骤使用

release:
  stage: release
  script:
    # 在 GitLab 上发布 Release
    - echo "第三阶段：发布"
    - |
      curl --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
           --data "name=Release for $(date +'%Y-%m-%d')" \
           --data "tag_name=v$(date +'%Y.%m.%d')" \
           --data "description=自动发布的 Release， PROJECT_ID $CI_PROJECT_ID" \
           --data "ref=main" \
           "https://gitlab.54sher.com/api/v4/projects/$CI_PROJECT_ID/releases"
    - echo "操作成功完成"
  dependencies:
    - build